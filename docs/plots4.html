<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adopted Stylesheets Farm</title>
    <style>
        body {
            margin: 0;
            background: #a6d785;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        .viewport {
            width: 100vw;
            height: 100vh;
            overflow: auto;
            display: flex;
            justify-content: center;
            padding-top: 100px;
        }

        .grid {
            position: relative;
            width: 600px;
        }

        .toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 50px;
            z-index: 1000;
        }

        .tool-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #444;
            background: white;
            font-size: 28px;
            cursor: pointer;
            transition: 0.3s;
        }

        .tool-btn.active {
            border-color: #ffeb3b;
            transform: scale(1.15);
        }
    </style>
</head>

<body>

    <div class="viewport">
        <div class="grid" id="garden"></div>
    </div>

    <div class="toolbar" id="toolbar-ui"></div>

    <script>
        /**
         * 1. –û–ë–©–ò–ï –°–¢–ò–õ–ò –ò –ö–õ–ê–°–°–´
         */

        // –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (–µ—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –æ–±—â–∏–µ)
        const plantBaseSheet = new CSSStyleSheet();
        plantBaseSheet.replaceSync(`
            :host { display: block; position: relative; z-index: 2; }
        `);

        class BasePlantFSM extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this.state = 0;
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏
                this.shadowRoot.adoptedStyleSheets = [plantBaseSheet];
            }

            connectedCallback() {
                this.render();
                this.timer = setInterval(() => this.nextStage(), this.growthRate);
            }

            nextStage() {
                if (this.state < this.maxStages) {
                    this.state++;
                    this.setAttribute('state', this.state); // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è CSS
                    this.render();
                    if (this.state === this.maxStages) {
                        clearInterval(this.timer);
                        this.dispatchEvent(new CustomEvent('plant-ripe', { bubbles: true, composed: true }));
                    }
                }
            }

            render() {
                this.shadowRoot.innerHTML = this.getHTML();
            }

            disconnectedCallback() { clearInterval(this.timer); }
        }

        /**
         * 2. –ú–û–†–ö–û–í–¨
         */
        const carrotSheet = new CSSStyleSheet();
        carrotSheet.replaceSync(`
            .carrot { transition: 0.5s; display: block; font-size: 20px; }
            :host([state="1"]) .carrot { font-size: 40px; }
            :host([state="2"]) .carrot { font-size: 60px; }
            .pests { position: absolute; top: 0; }
        `);

        class CarrotPlant extends BasePlantFSM {
            growthRate = 1500;
            maxStages = 2;

            constructor() {
                super();
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–æ—Ä–∫–æ–≤–∏ –∫ –±–∞–∑–æ–≤—ã–º
                this.shadowRoot.adoptedStyleSheets = [...this.shadowRoot.adoptedStyleSheets, carrotSheet];
            }

            getHTML() {
                return `
                    <div class="carrot">ü•ï</div>
                    <div class="pests"><slot name="pests"></slot></div>
                `;
            }
        }
        customElements.define('farm-carrot', CarrotPlant);

        /**
         * 3. –°–í–ï–ö–õ–ê
         */
        const beetSheet = new CSSStyleSheet();
        beetSheet.replaceSync(`
            .beet { font-size: 50px; opacity: 0.5; transition: 0.5s; }
            :host([state="1"]) .beet { opacity: 1; }
        `);

        class BeetPlant extends BasePlantFSM {
            growthRate = 2500; // –ù–µ–º–Ω–æ–≥–æ —É—Å–∫–æ—Ä–∏–º –¥–ª—è –¥–µ–º–æ
            maxStages = 1;

            constructor() {
                super();
                this.shadowRoot.adoptedStyleSheets = [...this.shadowRoot.adoptedStyleSheets, beetSheet];
            }

            getHTML() {
                return `
                    <div class="beet">üü£</div>
                    <slot name="pests"></slot>
                `;
            }
        }
        customElements.define('farm-beet', BeetPlant);

        /**
         * 4. –ì–†–Ø–î–ö–ê
         */
        const plotSheet = new CSSStyleSheet();
        plotSheet.replaceSync(`
        
        :host {
            position: absolute;
            width: 90px;
            height: 45px;
            /* –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –ª–æ–≤–∏—Ç—å—Å—è –Ω–∞ —ç—Ç–æ–º —Å–ª–æ–µ */
            pointer-events: all;
        }

        :host::before {
            content: "";
            position: absolute;
            inset: 0;
            background: #4caf50;
            clip-path: polygon(50% 0, 100% 50%, 50% 100%, 0 50%);
            z-index: 6;
            transition: background 0.2s;
        }

        :host:hover::before {
            background: yellow !important;
            cursor: pointer;
        }


        :host slot {
            position: absolute;
            left: 50%;
            bottom: 35%;
            width: 60px;
            transform: translateX(-50%);
            z-index: 2;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        :host.harvested img {
            opacity: 0;
            transform: translateX(-50%) translateY(20px) scale(0);
        }

        `

            // `
            //     :host { position: absolute; width: 90px; height: 45px; }
            //     .soil { 
            //         position: absolute; 
            //         inset: 0; 
            //         background: #4caf50; 
            //         clip-path: polygon(50% 0, 100% 50%, 50% 100%, 0 50%); 
            //         transition: 0.3s; 
            //     }
            //     :host([status="busy"]) .soil { background: #6b4f2c; }
            //     :host([status="ready"]) .soil { background: #3d2b1f; box-shadow: 0 0 15px gold; }
            //     .slot-point { 
            //         position: absolute; 
            //         left: 50%; 
            //         bottom: 30%; 
            //         transform: translateX(-50%); 
            //         z-index: 5; 
            //     }
            // `
        );

        class FarmPlot extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this.shadowRoot.adoptedStyleSheets = [plotSheet];
                this.shadowRoot.innerHTML = `
                    <slot></slot>
                `;
                this.addEventListener('plant-ripe', () => this.setAttribute('status', 'ready'));
            }

            tryPlant(tagName) {
                if (this.hasAttribute('status')) return;
                this.setAttribute('status', 'busy');
                this.appendChild(document.createElement(tagName));
            }

            tryHarvest() {
                if (this.getAttribute('status') === 'ready') {
                    this.removeAttribute('status');
                    this.innerHTML = '';
                }
            }
        }
        customElements.define('farm-plot', FarmPlot);

        /**
         * 5. –¢–£–õ–ë–ê–† –ò –õ–û–ì–ò–ö–ê
         */
        const Tools = {
            CARROT: { icon: 'ü•ï', apply: (plot) => plot.tryPlant('farm-carrot') },
            BEET: { icon: 'üü£', apply: (plot) => plot.tryPlant('farm-beet') },
            SICKLE: { icon: 'üåæ', apply: (plot) => plot.tryHarvest() }
        };

        class ToolbarController {
            constructor(container) {
                this.activeTool = Tools.CARROT;
                this.container = container;
                this.render();
            }

            render() {
                this.container.innerHTML = '';
                Object.values(Tools).forEach(tool => {
                    const btn = document.createElement('button');
                    btn.className = `tool-btn ${this.activeTool === tool ? 'active' : ''}`;
                    btn.innerHTML = tool.icon;
                    btn.onclick = () => {
                        this.activeTool = tool;
                        this.render();
                    };
                    this.container.appendChild(btn);
                });
            }

            use(plot) {
                this.activeTool.apply(plot);
            }
        }

        // –ó–∞–ø—É—Å–∫
        const toolbar = new ToolbarController(document.getElementById('toolbar-ui'));
        const garden = document.getElementById('garden');

        const COLS = 4, ROWS = 7;
        for (let i = 0; i < COLS * ROWS; i++) {
            const x = i % COLS;
            const y = Math.floor(i / COLS);
            const plot = document.createElement('farm-plot');
            plot.style.left = (COLS - 1) * 45 - (x - y) * 45 + 'px';
            plot.style.top = (x + y) * 22.5 + 'px';
            plot.onclick = () => toolbar.use(plot);
            garden.appendChild(plot);
        }
    </script>
</body>

</html>