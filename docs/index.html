<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Happy Farm 2000</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #game {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Game world - fixed size, background never crops */
        #game-world {
            position: absolute;
            width: 1200px;
            height: 900px;
            left: 50%;
            top: 50%;
            margin-left: -600px;
            margin-top: -450px;
            background: url('../deno/fsm/ui/background.jpg') no-repeat;
            background-size: 100% 100%;
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            /* z-index: 100; */
        }

        .user-panel {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.9), rgba(101, 67, 33, 0.9));
            border: 3px solid #8B4513;
            border-radius: 12px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .user-info {
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .username {
            font-weight: bold;
            font-size: 16px;
        }

        .user-level {
            font-size: 12px;
            color: #FFD700;
        }

        .resources {
            display: flex;
            gap: 8px;
        }

        .resource {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
            border: 2px solid #666;
            border-radius: 20px;
            padding: 6px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .resource.silver {
            border-color: #C0C0C0;
        }

        .resource.gold {
            border-color: #FFD700;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            border: 3px solid #8B4513;
            background: linear-gradient(135deg, #A0522D, #8B4513);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-3px);
        }

        /* Farm Grid - Isometric via positioning (no CSS rotation) */
        .farm-container {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 400px;
        }

        .farm-grid {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .plot {
            position: absolute;
            width: 100px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .plot:hover {
            filter: brightness(1.2);
            /* z-index: 10; */
        }

        .plot .crop-img {
            position: absolute;
            width: 100px;
            height: auto;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .plot .stage-indicator {
            position: absolute;
            bottom: 5px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 8px;
        }

        /* Toolbar */
        .toolbar {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.95));
            border: 3px solid #8B4513;
            border-radius: 16px;
            padding: 10px 20px;
            display: flex;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            /* z-index: 100; */
        }

        .tool {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #D2B48C, #C4A77D);
            border: 3px solid #8B4513;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool:hover {
            transform: translateY(-5px);
        }

        .tool.active {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            border-color: #2E7D32;
        }

        /* Map Objects (Factories, Animals, Buildings) */
        .map-object {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
            /* z-index: 50; */
        }

        .map-object:hover {
            filter: brightness(1.1);
        }

        .map-object .object-icon {
            font-size: 70px;
            filter: drop-shadow(3px 5px 8px rgba(0, 0, 0, 0.6));
        }

        .map-object .object-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            white-space: nowrap;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            /* z-index: 1000; */
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #F5DEB3, #DEB887);
            border: 4px solid #8B4513;
            border-radius: 16px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8B4513;
        }

        .modal-title {
            font-size: 20px;
            color: #5D4037;
            font-weight: bold;
        }

        .modal-close {
            background: #c62828;
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .shop-item {
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-item:hover {
            transform: scale(1.05);
            border-color: #4CAF50;
        }

        .shop-item-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .shop-item-name {
            font-size: 12px;
            color: #5D4037;
            font-weight: bold;
        }

        .shop-item-price {
            font-size: 11px;
            color: #FF9800;
            font-weight: bold;
            margin-top: 4px;
        }

        /* Exp Bar */
        .exp-bar {
            position: absolute;
            top: 70px;
            left: 10px;
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid #9C27B0;
            overflow: hidden;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9C27B0, #E040FB);
            width: 35%;
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }
    </style>
</head>

<body>
    <div id="game">
        <!-- Game World (scales with background) -->
        <div id="game-world">
            <!-- Factories/Buildings layer (behind plots) -->
            <div id="factories-layer"></div>
            <!-- Farm Grid (in front) -->
            <div class="farm-container">
                <div class="farm-grid" id="farm-grid"></div>
            </div>
        </div>

        <!-- UI Layer (fixed to screen) -->
        <!-- Top Bar -->
        <div class="top-bar">
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <div class="user-panel">
                    <div class="avatar" id="avatar">?</div>
                    <div class="user-info">
                        <div class="username" id="username"></div>
                        <div class="user-level" id="level-text"></div>
                    </div>
                </div>
                <div class="exp-bar">
                    <div class="exp-fill" id="exp-fill"></div>
                    <div class="exp-text" id="exp-text">350 / 1000</div>
                </div>
            </div>

            <div class="resources">
                <div class="resource silver"><span>ü™ô</span><span id="silver">1,250</span></div>
                <div class="resource gold"><span>üíé</span><span id="gold">50</span></div>
            </div>

            <div class="action-buttons">
                <div class="action-btn" onclick="showModal('shop')">üõí</div>
                <div class="action-btn" onclick="showModal('warehouse')">üì¶</div>
                <div class="action-btn" onclick="showModal('friends')">üë•</div>
                <div class="action-btn" onclick="showModal('settings')">‚öôÔ∏è</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="tool active" data-tool="plant">üå±</div>
            <div class="tool" data-tool="water">üíß</div>
            <div class="tool" data-tool="harvest">üåæ</div>
            <div class="tool" data-tool="fertilize">üí©</div>
            <div class="tool" data-tool="remove">üóëÔ∏è</div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title"></h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const isLocal =
            window.location.protocol === 'file:' ||
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1';

        const API_URL = isLocal
            ? 'http://localhost:8000'
            : 'https://happyfarmer2000.bacek97.deno.net';
        const LANG = 'ru';
        let configs = {}, currentTool = 'plant', plots = [];

        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        async function api(path) {
            try { return await (await fetch(`${API_URL}${path}`)).json(); }
            catch (e) { console.error('API Error:', e); return null; }
        }

        function text(obj) { return obj?.[LANG] || obj?.en || ''; }

        // ===== Hasura GraphQL =====
        const HASURA_URL = 'https://happy-farmer-2000.hasura.app/v1/graphql';

        const initData = tg?.initData || '';
        let inventory = {}; // {seed_tomato: 5, item_wheat: 10, silver: 1000}
        let userId = tg?.initDataUnsafe?.user?.id || 0;

        async function gql(query, variables = {}) {
            try {
                const res = await fetch(HASURA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': initData
                    },
                    body: JSON.stringify({ query, variables })
                });
                const json = await res.json();
                if (json.errors) {
                    console.error('GraphQL errors:', json.errors);
                    throw new Error(json.errors[0]?.message || 'GraphQL error');
                }
                return json.data;
            } catch (e) {
                console.error('GQL Error:', e);
                return null;
            }
        }

        // Load user inventory from user_stats
        async function loadInventory() {
            const data = await gql(`
                query {
                    user_stats {
                        key
                        value
                    }
                }
            `);
            inventory = {};
            (data?.user_stats || []).forEach(s => {
                inventory[s.key] = s.value;
            });
            updateResourcesUI();
            return inventory;
        }

        // Update single stat in DB
        async function updateStat(key, value) {
            await gql(`
                mutation($key: String!, $value: Int!) {
                    insert_user_stats_one(
                        object: {key: $key, value: $value}
                        on_conflict: {constraint: user_stats_pkey, update_columns: [value, updated_at]}
                    ) { key }
                }
            `, { key, value });
            inventory[key] = value;
        }

        // Add/subtract from stat
        async function modifyStat(key, delta) {
            const current = inventory[key] || 0;
            const newVal = Math.max(0, current + delta);
            await updateStat(key, newVal);
            return newVal;
        }

        function updateResourcesUI() {
            document.getElementById('silver').textContent = (inventory.silver || 0).toLocaleString();
            document.getElementById('gold').textContent = (inventory.gold || 0).toLocaleString();
        }

        // Map panning functionality
        let isPanning = false, startX = 0, startY = 0, panX = 0, panY = 0;

        function initMapPanning() {
            const gameWorld = document.getElementById('game-world');

            // Mouse events (desktop)
            gameWorld.addEventListener('mousedown', (e) => {
                if (e.target.closest('.map-object, .plot, .tool, .action-btn')) return;
                isPanning = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                gameWorld.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                updatePan();
            });

            document.addEventListener('mouseup', () => {
                isPanning = false;
                document.getElementById('game-world').style.cursor = 'grab';
            });

            // Touch events (mobile)
            gameWorld.addEventListener('touchstart', (e) => {
                if (e.target.closest('.map-object, .plot, .tool, .action-btn')) return;
                if (e.touches.length === 1) {
                    isPanning = true;
                    startX = e.touches[0].clientX - panX;
                    startY = e.touches[0].clientY - panY;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isPanning || e.touches.length !== 1) return;
                panX = e.touches[0].clientX - startX;
                panY = e.touches[0].clientY - startY;
                updatePan();
            }, { passive: true });

            document.addEventListener('touchend', () => { isPanning = false; });

            gameWorld.style.cursor = 'grab';
        }

        function updatePan() {
            const gameWorld = document.getElementById('game-world');
            gameWorld.style.transform = `translate(${panX}px, ${panY}px)`;
        }

        async function init() {
            const user = tg?.initDataUnsafe?.user;
            document.getElementById('username').textContent = user?.first_name || 'Player';
            document.getElementById('avatar').textContent = (user?.first_name || 'P')[0];

            configs = await api('/api/configs');
            const plotCfg = await api('/api/configs/plots/plot');
            document.getElementById('level-text').textContent = `Level 5`;

            // Load user inventory from database
            await loadInventory();

            // Load map objects (factories) FIRST so they appear behind plots
            await loadMapObjects();

            // Create plots
            const grid = document.getElementById('farm-grid');
            const emptyPlotImg = plotCfg?.stages?.empty?.image;
            const blockedPlotImg = plotCfg?.stages?.blocked?.image;
            const basePlots = plotCfg?.base_plots || 6;
            const totalPlots = plotCfg?.total_plots || 32;
            const cols = 4;
            const gapX = 52, gapY = 26; // half tile size for isometric grid

            for (let i = 0; i < totalPlots; i++) {
                const isBlocked = i >= basePlots;
                plots[i] = { state: isBlocked ? 'blocked' : 'empty', crop: null, stage: 0 };
                const row = Math.floor(i / cols);
                const col = i % cols;

                // Isometric diamond grid positioning (row 0 at top-left)
                const x = (row - col) * gapX + 200;
                const y = (col + row) * gapY + 50;

                const plot = document.createElement('div');
                plot.className = isBlocked ? 'plot blocked' : 'plot empty';
                plot.dataset.id = i;
                plot.style.left = `${x}px`;
                plot.style.top = `${y}px`;

                const plotImg = isBlocked ? blockedPlotImg : emptyPlotImg;
                if (plotImg) {
                    plot.style.backgroundImage = `url('../deno/${plotImg}')`;
                }
                if (isBlocked) {
                    plot.style.opacity = '0.5';
                }
                plot.onclick = () => onPlotClick(i);
                grid.appendChild(plot);
            }

            // Setup toolbar
            document.querySelectorAll('.tool').forEach(tool => {
                tool.onclick = () => {
                    document.querySelector('.tool.active')?.classList.remove('active');
                    tool.classList.add('active');
                    currentTool = tool.dataset.tool;
                };
            });

            // Enable map panning
            initMapPanning();
        }

        async function loadMapObjects() {
            const factoriesLayer = document.getElementById('factories-layer');
            const factories = await api('/api/configs/factories');

            for (const [code, cfg] of Object.entries(factories || {})) {
                if (!cfg.position) continue; // Skip factories without position

                const isDecoration = cfg.decoration === true;
                const obj = document.createElement('div');
                obj.className = isDecoration ? 'map-object decoration' : 'map-object';
                // Position from center using translate for proper background attachment
                obj.style.left = '50%';
                obj.style.top = '50%';
                obj.style.transform = `translate(${cfg.position.x}%, ${cfg.position.y}%)`;
                if (isDecoration) {
                    obj.style.pointerEvents = 'none';
                    obj.style.cursor = 'default';
                }

                // Get image from stages (default to idle)
                const stageImage = cfg.stages?.idle?.image || cfg.stages?.ready?.image;
                const imagePath = stageImage ? `../deno/${stageImage}` : null;

                const iconWidth = cfg.size?.width || 80;
                const iconHtml = imagePath
                    ? `<img src="${imagePath}" alt="${text(cfg.name)}" style="width:${iconWidth}px;height:auto;">`
                    : `<span style="font-size:70px">${cfg.icon || 'üè≠'}</span>`;

                // Decorations don't have labels
                obj.innerHTML = isDecoration
                    ? `<div class="object-icon">${iconHtml}</div>`
                    : `<div class="object-icon">${iconHtml}</div><div class="object-label">${text(cfg.name)}</div>`;

                if (!isDecoration) {
                    obj.onclick = () => showFactoryModal(code, cfg);
                }
                factoriesLayer.appendChild(obj);
            }
        }

        async function showFactoryModal(code, cfg) {
            document.getElementById('modal-title').textContent = text(cfg.name);
            const crops = await api('/api/configs/crops');

            let html = `<p style="margin-bottom:15px;color:#5D4037">${text(cfg.description)}</p>`;
            html += '<div class="shop-grid">';

            for (const recipe of cfg.recipes || []) {
                // Check ingredients
                let ingredientsHtml = '';
                let canProduce = true;

                for (const input of recipe.inputs || []) {
                    const itemKey = `item_${input.item}`;
                    const have = inventory[itemKey] || 0;
                    const need = input.count;
                    const enough = have >= need;
                    if (!enough) canProduce = false;

                    const cropCfg = crops?.[input.item];
                    const itemName = text(cropCfg?.name) || input.item;
                    const color = enough ? '#4CAF50' : '#F44336';
                    ingredientsHtml += `<div style="font-size:11px;color:${color}">${itemName}: ${have}/${need}</div>`;
                }

                const btnStyle = canProduce
                    ? 'background:#4CAF50;color:white;cursor:pointer'
                    : 'background:#ccc;color:#666;cursor:not-allowed';
                const onclick = canProduce
                    ? `startProduction('${code}','${recipe.code}')`
                    : '';

                // Get product icon
                const product = recipe.products?.[0];
                const productIcon = product?.code?.includes('juice') ? 'üßÉ' : product?.code?.includes('chips') ? 'üçü' : 'üì¶';

                html += `<div class="shop-item" ${onclick ? `onclick="${onclick}"` : ''}>
                    <div class="shop-item-icon">${productIcon}</div>
                    <div class="shop-item-name">${text(recipe.name)}</div>
                    <div style="font-size:10px;color:#888">‚è± ${Math.floor(recipe.time / 60)}–º–∏–Ω</div>
                    <div style="margin-top:5px;border-top:1px solid #eee;padding-top:5px">
                        ${ingredientsHtml}
                    </div>
                    <div style="margin-top:5px;padding:3px 6px;border-radius:4px;${btnStyle}">
                        ${canProduce ? '‚ñ∂ –ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏' : '‚úó –ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤'}
                    </div>
                </div>`;
            }
            html += '</div>';
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal').classList.add('active');
        }

        // Store current factory configs for startProduction
        let factoryConfigs = {};

        async function startProduction(factoryCode, recipeCode) {
            // Get factory config
            const cfg = await api(`/api/configs/factories/${factoryCode}`);
            const recipe = cfg?.recipes?.find(r => r.code === recipeCode);
            if (!recipe) {
                alert('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            // Check and deduct ingredients
            for (const input of recipe.inputs || []) {
                const itemKey = `item_${input.item}`;
                const have = inventory[itemKey] || 0;
                if (have < input.count) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${input.item}!`);
                    return;
                }
            }

            // Deduct ingredients
            for (const input of recipe.inputs || []) {
                await modifyStat(`item_${input.item}`, -input.count);
            }

            closeModal();

            // Add products after production time (simplified - instant for demo)
            for (const product of recipe.products || []) {
                await modifyStat(`item_${product.code}`, product.count);
            }

            // Add experience
            await modifyStat('exp', recipe.exp || 10);

            alert(`${text(recipe.name)} –≥–æ—Ç–æ–≤!`);
        }

        window.startProduction = startProduction;

        async function onPlotClick(id) {
            const plot = plots[id];
            if (currentTool === 'plant' && plot.state === 'empty') {
                await showCropSelector(id);
            } else if (currentTool === 'harvest' && plot.state === 'ready') {
                await harvestCrop(id);
            }
        }

        async function showCropSelector(plotId) {
            const crops = await api('/api/configs/crops');
            const plotCfg = await api('/api/configs/plots/plot');
            document.getElementById('modal-title').textContent = text(plotCfg?.ui?.labels?.select_crop) || 'Select Crop';
            document.getElementById('modal-body').innerHTML = `
                <div class="shop-grid">
                    ${Object.entries(crops || {}).map(([code, c]) => {
                const seedImg = c.stages?.seed?.image;
                const iconHtml = seedImg
                    ? `<img src="../deno/${seedImg}" style="width:40px;height:auto;">`
                    : 'üå±';
                return `
                        <div class="shop-item" onclick="plantCrop(${plotId}, '${code}')">
                            <div class="shop-item-icon">${iconHtml}</div>
                            <div class="shop-item-name">${text(c.name)}</div>
                            <div class="shop-item-price">${c.buy_silver} ü™ô</div>
                        </div>
                    `}).join('')}
                </div>
            `;
            document.getElementById('modal').classList.add('active');
        }

        async function plantCrop(plotId, cropCode) {
            // Check if user has seeds
            const seedKey = `seed_${cropCode}`;
            if ((inventory[seedKey] || 0) < 1) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–µ–º—è–Ω! –ö—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.');
                return;
            }

            closeModal();

            // Use seed from inventory
            await modifyStat(seedKey, -1);

            const cropCfg = await api(`/api/configs/crops/${cropCode}`);
            const plotEl = document.querySelector(`.plot[data-id="${plotId}"]`);
            plots[plotId] = { state: 'planted', crop: cropCode, stage: 'seed', config: cropCfg };
            plotEl.classList.remove('empty');
            plotEl.classList.add('planted');

            const stageNames = { seed: '1/4', sprout: '2/4', growing: '3/4', ripe: '‚úì' };

            function updatePlotImage(stage) {
                const img = cropCfg?.stages?.[stage]?.image;
                const html = img
                    ? `<img src="../deno/${img}" class="crop-img">`
                    : `<div class="crop-img" style="font-size:30px;text-align:center">${stage === 'ripe' ? 'üçé' : 'üå±'}</div>`;
                plotEl.innerHTML = `${html}<span class="stage-indicator">${stageNames[stage]}</span>`;
            }

            updatePlotImage('seed');
            setTimeout(() => updatePlotImage('sprout'), 3000);
            setTimeout(() => updatePlotImage('growing'), 6000);
            setTimeout(() => { updatePlotImage('ripe'); plots[plotId].state = 'ready'; }, 9000);
        }

        async function harvestCrop(plotId) {
            const plot = plots[plotId];
            const cropCode = plot?.crop;
            const cropCfg = plot?.config;

            const plotEl = document.querySelector(`.plot[data-id="${plotId}"]`);
            const plotCfg = await api('/api/configs/plots/plot');
            const emptyPlotImg = plotCfg?.stages?.empty?.image;

            // Calculate yield (random between min and max)
            const yieldRange = cropCfg?.yield || [1, 3];
            const harvestQty = Math.floor(Math.random() * (yieldRange[1] - yieldRange[0] + 1)) + yieldRange[0];

            // Add to warehouse inventory
            const itemKey = `item_${cropCode}`;
            await modifyStat(itemKey, harvestQty);

            // Add experience
            const exp = cropCfg?.exp || 5;
            await modifyStat('exp', exp);

            // Show harvest animation
            plotEl.innerHTML = `<div style="color:white;font-size:14px;text-shadow:1px 1px 2px black">+${harvestQty} üçé</div>`;

            setTimeout(() => {
                plotEl.innerHTML = '';
                plotEl.classList.remove('planted');
                plotEl.classList.add('empty');
                if (emptyPlotImg) {
                    plotEl.style.backgroundImage = `url('../deno/${emptyPlotImg}')`;
                }
                plots[plotId] = { state: 'empty', crop: null, stage: 0 };
            }, 1000);
        }

        async function showModal(type) {
            const cfg = await api(`/api/configs/ui/${type}`);
            document.getElementById('modal-title').textContent = text(cfg?.name) || type;

            if (type === 'shop') {
                // Shop: buy seeds
                const crops = await api('/api/configs/crops');
                let html = '<h4 style="margin:0 0 10px;color:#5D4037">–°–µ–º–µ–Ω–∞</h4><div class="shop-grid">';
                for (const [code, c] of Object.entries(crops || {})) {
                    const seedImg = c.stages?.seed?.image;
                    const iconHtml = seedImg ? `<img src="../deno/${seedImg}" style="width:40px;height:auto;">` : 'üå±';
                    const owned = inventory[`seed_${code}`] || 0;
                    html += `<div class="shop-item" onclick="buySeed('${code}', ${c.buy_silver})">
                        <div class="shop-item-icon">${iconHtml}</div>
                        <div class="shop-item-name">${text(c.name)}</div>
                        <div class="shop-item-price">${c.buy_silver} ü™ô</div>
                        <div style="font-size:10px;color:#666">–ï—Å—Ç—å: ${owned}</div>
                    </div>`;
                }
                html += '</div>';
                document.getElementById('modal-body').innerHTML = html;

            } else if (type === 'warehouse') {
                // Warehouse: show items with sell button
                const crops = await api('/api/configs/crops');
                const items = Object.entries(inventory).filter(([k]) => k.startsWith('item_'));

                if (items.length === 0) {
                    document.getElementById('modal-body').innerHTML = '<p style="color:#888;text-align:center">–°–∫–ª–∞–¥ –ø—É—Å—Ç</p>';
                } else {
                    let html = '<div class="shop-grid">';
                    for (const [key, qty] of items) {
                        const code = key.replace('item_', '');
                        const cropCfg = crops?.[code];
                        const ripeImg = cropCfg?.stages?.ripe?.image;
                        const iconHtml = ripeImg ? `<img src="../deno/${ripeImg}" style="width:40px;height:auto;">` : 'üì¶';
                        const sellPrice = cropCfg?.sell_silver || 10;
                        html += `<div class="shop-item">
                            <div class="shop-item-icon">${iconHtml}</div>
                            <div class="shop-item-name">${text(cropCfg?.name) || code}</div>
                            <div style="font-size:12px">${qty} —à—Ç</div>
                            <button onclick="sellItem('${code}', 1, ${sellPrice})" style="margin-top:5px;padding:4px 8px;cursor:pointer">
                                –ü—Ä–æ–¥–∞—Ç—å 1 –∑–∞ ${sellPrice}ü™ô
                            </button>
                        </div>`;
                    }
                    html += '</div>';
                    document.getElementById('modal-body').innerHTML = html;
                }

            } else if (type === 'friends') {
                document.getElementById('modal-body').innerHTML = '<p style="color:#888;text-align:center">–î—Ä—É–∑—å—è —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è!</p>';

            } else if (type === 'settings') {
                document.getElementById('modal-body').innerHTML = `
                    <p>–Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π</p>
                    <p>–ó–≤—É–∫–∏: –í–∫–ª</p>
                `;
            } else {
                document.getElementById('modal-body').innerHTML = `<p>${text(cfg?.description) || ''}</p>`;
            }
            document.getElementById('modal').classList.add('active');
        }

        // Buy seed
        async function buySeed(cropCode, price) {
            if ((inventory.silver || 0) < price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
                return;
            }
            await modifyStat('silver', -price);
            await modifyStat(`seed_${cropCode}`, 1);
            updateResourcesUI();
            showModal('shop'); // Refresh
        }

        // Sell item from warehouse
        async function sellItem(itemCode, qty, pricePerUnit) {
            const key = `item_${itemCode}`;
            if ((inventory[key] || 0) < qty) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞!');
                return;
            }
            await modifyStat(key, -qty);
            await modifyStat('silver', pricePerUnit * qty);
            updateResourcesUI();
            showModal('warehouse'); // Refresh
        }

        window.buySeed = buySeed;
        window.sellItem = sellItem;

        function closeModal() { document.getElementById('modal').classList.remove('active'); }

        init();
    </script>
</body>

</html>