<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Happy Farm 2000</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #game {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Game world - fixed size, background never crops */
        #game-world {
            position: absolute;
            width: 1200px;
            height: 900px;
            left: 50%;
            top: 50%;
            margin-left: -600px;
            margin-top: -450px;
            background: url('../deno/fsm/ui/background.jpg') no-repeat;
            background-size: 100% 100%;
        }

        /* Top Left Stats */
        .top-left-stats {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            z-index: 100;
        }

        .level-circle {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border: 4px solid #81C784;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .stats-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-panel {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.9), rgba(101, 67, 33, 0.9));
            border: 3px solid #8B4513;
            border-radius: 12px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .user-info {
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .username {
            font-weight: bold;
            font-size: 16px;
        }

        .user-level {
            font-size: 12px;
            color: #FFD700;
        }

        .resources {
            position: fixed;
            top: 70px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }

        .resource {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
            border: 2px solid #666;
            border-radius: 20px;
            padding: 6px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .resource.silver {
            border-color: #C0C0C0;
        }

        .resource.gold {
            border-color: #FFD700;
        }

        /* Right sidebar buttons (vertical) */
        .right-sidebar {
            position: fixed;
            right: 10px;
            top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .sidebar-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-btn:hover {
            transform: scale(1.1);
        }

        .sidebar-btn.cyan {
            background: linear-gradient(135deg, #4DD0E1, #00ACC1);
        }

        .sidebar-btn.green {
            background: linear-gradient(135deg, #81C784, #4CAF50);
        }

        .sidebar-btn.orange {
            background: linear-gradient(135deg, #FFB74D, #FF9800);
        }

        .sidebar-btn.red {
            background: linear-gradient(135deg, #E57373, #F44336);
        }

        .sidebar-btn.yellow {
            background: linear-gradient(135deg, #FFF176, #FFEB3B);
        }

        /* Bottom toolbar with labels */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #f5f5f5, #e0e0e0);
            padding: 8px 10px 12px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .toolbar-item:hover {
            transform: translateY(-3px);
        }

        .toolbar-item .icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, #C5E1A5, #8BC34A);
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .toolbar-item .icon.active {
            background: linear-gradient(135deg, #81C784, #4CAF50);
            border-color: #388E3C;
        }

        .toolbar-item .label {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        .farm-container {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 400px;
        }

        .farm-grid {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .plot {
            position: absolute;
            width: 100px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .plot:hover {
            filter: brightness(1.2);
            /* z-index: 10; */
        }

        .plot .crop-img {
            position: absolute;
            width: 100px;
            height: auto;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .plot .stage-indicator {
            position: absolute;
            bottom: 5px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 8px;
        }

        /* Toolbar */
        /* Bottom toolbar with labels */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #f5f5f5, #e0e0e0);
            padding: 8px 10px 12px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .toolbar-item:hover {
            transform: translateY(-3px);
        }

        .toolbar-item .icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, #C5E1A5, #8BC34A);
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .toolbar-item .icon.active {
            background: linear-gradient(135deg, #81C784, #4CAF50);
            border-color: #388E3C;
        }

        .toolbar-item .label {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        /* Map Objects (Factories, Animals, Buildings) */
        .map-object {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
            /* z-index: 50; */
        }

        .map-object:hover {
            filter: brightness(1.1);
        }

        .map-object .object-icon {
            font-size: 70px;
            filter: drop-shadow(3px 5px 8px rgba(0, 0, 0, 0.6));
        }

        .map-object .object-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            white-space: nowrap;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            /* z-index: 1000; */
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #f0f0f0;
            border-radius: 12px;
            max-width: 450px;
            width: 95%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #4a4a4a;
            color: white;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            max-height: calc(85vh - 100px);
            background: #e8e8e8;
        }

        .modal-footer {
            padding: 12px 16px;
            background: #d0d0d0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #bbb;
        }

        .modal-footer .total-price {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: #333;
        }

        .modal-footer .btn-action {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-footer .btn-action:hover {
            background: linear-gradient(135deg, #66BB6A, #43A047);
        }

        /* Item grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .shop-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .shop-item:hover {
            border-color: #4CAF50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .shop-item-icon {
            font-size: 40px;
            margin-bottom: 6px;
        }

        .shop-item-icon img {
            width: 50px;
            height: auto;
        }

        .shop-item-name {
            font-size: 12px;
            color: #333;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .shop-item-price {
            font-size: 11px;
            color: #FF9800;
            font-weight: bold;
        }

        .shop-item-qty {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #4CAF50;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Quantity selector */
        .qty-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .qty-selector button {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: #4a4a4a;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .qty-selector button:hover {
            background: #666;
        }

        .qty-selector input {
            width: 40px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            font-size: 14px;
        }

        /* Submodal (confirmation dialog) */
        .submodal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .submodal.active {
            display: flex;
        }

        .submodal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .submodal-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .submodal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .submodal-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .submodal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .submodal-buttons button {
            padding: 10px 24px;
            border: 2px solid #4a90d9;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .submodal-buttons .btn-ok {
            background: #4a90d9;
            color: white;
        }

        .submodal-buttons .btn-cancel {
            background: white;
            color: #4a90d9;
        }

        /* Exp Bar */
        .exp-bar {
            position: absolute;
            top: 70px;
            left: 10px;
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid #9C27B0;
            overflow: hidden;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9C27B0, #E040FB);
            width: 35%;
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }
    </style>
</head>

<body>
    <div id="game">
        <!-- Game World (scales with background) -->
        <div id="game-world">
            <!-- Factories/Buildings layer (behind plots) -->
            <div id="factories-layer"></div>
            <!-- Farm Grid (in front) -->
            <div class="farm-container">
                <div class="farm-grid" id="farm-grid"></div>
            </div>
        </div>

        <!-- UI Layer (fixed to screen) -->
        <!-- Top Left Stats -->
        <div class="top-left-stats">
            <div class="level-circle" id="level-circle">50</div>
            <div class="stats-column">
                <div class="resource silver"><span>ü™ô</span><span id="silver">1,250</span></div>
                <div class="resource gold"><span>üíé</span><span id="gold">50</span></div>
            </div>
        </div>

        <!-- Right Sidebar (vertical buttons) -->
        <div class="right-sidebar">
            <div class="sidebar-btn cyan" onclick="showModal('settings')">‚öôÔ∏è</div>
            <div class="sidebar-btn green" onclick="showModal('friends')">üë•</div>
            <div class="sidebar-btn orange" onclick="showModal('achievements')">üèÜ</div>
            <div class="sidebar-btn red" onclick="showModal('notifications')">üîî</div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="bottom-toolbar">
            <div class="toolbar-item" onclick="showModal('warehouse')">
                <div class="icon">üëú</div>
                <span class="label">–°—É–º–∫–∞</span>
            </div>
            <div class="toolbar-item" data-tool="harvest">
                <div class="icon">üåæ</div>
                <span class="label">–£—Ä–æ–∂–∞–π</span>
            </div>
            <div class="toolbar-item" onclick="showModal('shop')">
                <div class="icon">üõí</div>
                <span class="label">–ú–∞–≥–∞–∑–∏–Ω</span>
            </div>
            <div class="toolbar-item" onclick="showModal('friends')">
                <div class="icon">üë®‚Äçüåæ</div>
                <span class="label">–§–µ—Ä–º–µ—Ä—ã</span>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modal-title"></span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer" style="display:none">
                <div class="total-price">
                    <span>–¶–µ–Ω–∞:</span>
                    <span>ü™ô</span>
                    <span id="modal-total">0</span>
                </div>
                <button class="btn-action" id="modal-action-btn">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>
            </div>
        </div>
    </div>

    <!-- Submodal (confirmation) -->
    <div class="submodal" id="submodal">
        <div class="submodal-content">
            <div class="submodal-icon">‚ÑπÔ∏è</div>
            <div class="submodal-title" id="submodal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            <div class="submodal-text" id="submodal-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
            <div class="submodal-buttons">
                <button class="btn-ok" id="submodal-ok">OK</button>
                <button class="btn-cancel" onclick="closeSubmodal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        const isLocal =
            window.location.protocol === 'file:' ||
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1';

        const API_URL = isLocal
            ? 'http://localhost:8000'
            : 'https://happyfarmer2000.bacek97.deno.net';
        const LANG = 'ru';
        let configs = {}, currentTool = 'plant', plots = [];

        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        async function api(path) {
            try { return await (await fetch(`${API_URL}${path}`)).json(); }
            catch (e) { console.error('API Error:', e); return null; }
        }

        function text(obj) { return obj?.[LANG] || obj?.en || ''; }

        // ===== Hasura GraphQL =====
        const HASURA_URL = 'https://happy-farmer-2000.hasura.app/v1/graphql';

        const initData = tg?.initData || '';
        let inventory = {}; // {seed_tomato: 5, item_wheat: 10, silver: 1000}
        let userId = tg?.initDataUnsafe?.user?.id || 0;

        async function gql(query, variables = {}) {
            try {
                const res = await fetch(HASURA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': initData
                    },
                    body: JSON.stringify({ query, variables })
                });
                const json = await res.json();
                if (json.errors) {
                    console.error('GraphQL errors:', json.errors);
                    throw new Error(json.errors[0]?.message || 'GraphQL error');
                }
                return json.data;
            } catch (e) {
                console.error('GQL Error:', e);
                return null;
            }
        }

        // Load user inventory from user_stats
        async function loadInventory() {
            const data = await gql(`
                query {
                    user_stats {
                        key
                        value
                    }
                }
            `);
            inventory = {};
            (data?.user_stats || []).forEach(s => {
                inventory[s.key] = s.value;
            });
            updateResourcesUI();
            return inventory;
        }

        // Update single stat in DB
        async function updateStat(key, value) {
            await gql(`
                mutation($key: String!, $value: Int!) {
                    insert_user_stats_one(
                        object: {key: $key, value: $value}
                        on_conflict: {constraint: user_stats_pkey, update_columns: [value, updated_at]}
                    ) { key }
                }
            `, { key, value });
            inventory[key] = value;
        }

        // Add/subtract from stat
        async function modifyStat(key, delta) {
            const current = inventory[key] || 0;
            const newVal = Math.max(0, current + delta);
            await updateStat(key, newVal);
            return newVal;
        }

        function updateResourcesUI() {
            document.getElementById('silver').textContent = (inventory.silver || 0).toLocaleString();
            document.getElementById('gold').textContent = (inventory.gold || 0).toLocaleString();
        }

        // ===== Planted Crops DB =====

        // Save planted crop to DB
        async function savePlantedCrop(plotId, cropCode, stage, plantedAt) {
            console.log('[DB] Saving crop:', { plotId, cropCode, stage, plantedAt });
            const typeCode = `crop_${cropCode}`;
            const plantedAtStr = plantedAt.toString();

            // First create the game object
            const data = await gql(`
                mutation($typeCode: String!, $x: Int!) {
                    insert_game_objects_one(object: {
                        type_code: $typeCode,
                        x: $x,
                        y: 0
                    }) {
                        id
                    }
                }
            `, { typeCode, x: plotId });

            console.log('[DB] Created game_object:', data);

            if (data?.insert_game_objects_one?.id) {
                const objectId = data.insert_game_objects_one.id;
                // Save params
                const paramsData = await gql(`
                    mutation($objectId: Int!, $stage: String!, $plantedAt: String!) {
                        insert_game_object_params(objects: [
                            {object_id: $objectId, key: "stage", value: $stage},
                            {object_id: $objectId, key: "planted_at", value: $plantedAt}
                        ]) { affected_rows }
                    }
                `, { objectId, stage, plantedAt: plantedAtStr });
                console.log('[DB] Created params:', paramsData);
                return objectId;
            }
            return null;
        }

        // Load all planted crops from DB
        async function loadPlantedCrops() {
            console.log('[DB] Loading planted crops...');
            const data = await gql(`
                query {
                    game_objects(where: {type_code: {_like: "crop_%"}}) {
                        id
                        type_code
                        x
                        created_at
                        params {
                            key
                            value
                        }
                    }
                }
            `);
            return data?.game_objects || [];
        }

        // Delete planted crop from DB (on harvest)
        async function deletePlantedCrop(plotId) {
            await gql(`
                mutation($plotId: Int!) {
                    delete_game_objects(where: {x: {_eq: $plotId}, type_code: {_like: "crop_%"}}) {
                        affected_rows
                    }
                }
            `, { plotId });
        }

        // Restore planted crops from database on game load
        async function restorePlantedCrops() {
            console.log('[DB] Restoring planted crops...');
            const plantedCrops = await loadPlantedCrops();
            console.log('[DB] Found crops:', plantedCrops);

            for (const obj of plantedCrops) {
                const plotId = obj.x;
                const cropCode = obj.type_code.replace('crop_', '');
                const params = {};
                (obj.params || []).forEach(p => {
                    params[p.key] = p.value;
                });

                const plantedAt = parseInt(params.planted_at) || new Date(obj.created_at).getTime();
                const cropCfg = await api(`/api/configs/crops/${cropCode}`);
                if (!cropCfg) continue;

                // Calculate current stage based on time elapsed
                const elapsed = Date.now() - plantedAt;
                const stageTimes = cropCfg.stage_times || [30000, 60000, 90000]; // default 30s per stage
                const totalGrowTime = stageTimes.reduce((a, b) => a + b * 1000, 0);

                let currentStage = 'seed';
                let isReady = false;
                let timeSum = 0;
                const stages = ['seed', 'sprout', 'growing', 'ripe'];

                for (let i = 0; i < stageTimes.length; i++) {
                    timeSum += stageTimes[i] * 1000;
                    if (elapsed >= timeSum && i < stages.length - 1) {
                        currentStage = stages[i + 1];
                    }
                }

                if (elapsed >= totalGrowTime) {
                    currentStage = 'ripe';
                    isReady = true;
                }

                // Update plot state
                plots[plotId] = {
                    state: isReady ? 'ready' : 'planted',
                    crop: cropCode,
                    stage: currentStage,
                    config: cropCfg,
                    plantedAt
                };

                // Update plot visual
                const plotEl = document.querySelector(`.plot[data-id="${plotId}"]`);
                if (plotEl) {
                    plotEl.classList.remove('empty', 'blocked');
                    plotEl.classList.add('planted');

                    const stageNames = { seed: '1/4', sprout: '2/4', growing: '3/4', ripe: '‚úì' };
                    const img = cropCfg?.stages?.[currentStage]?.image;
                    const html = img
                        ? `<img src="../deno/${img}" class="crop-img">`
                        : `<div class="crop-img" style="font-size:30px;text-align:center">${currentStage === 'ripe' ? 'üçé' : 'üå±'}</div>`;
                    plotEl.innerHTML = `${html}<span class="stage-indicator">${stageNames[currentStage]}</span>`;
                }
            }
        }

        // Map panning functionality
        let isPanning = false, startX = 0, startY = 0, panX = 0, panY = 0;

        function initMapPanning() {
            const gameWorld = document.getElementById('game-world');

            // Mouse events (desktop)
            gameWorld.addEventListener('mousedown', (e) => {
                if (e.target.closest('.map-object, .plot, .tool, .action-btn')) return;
                isPanning = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                gameWorld.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                updatePan();
            });

            document.addEventListener('mouseup', () => {
                isPanning = false;
                document.getElementById('game-world').style.cursor = 'grab';
            });

            // Touch events (mobile)
            gameWorld.addEventListener('touchstart', (e) => {
                if (e.target.closest('.map-object, .plot, .tool, .action-btn')) return;
                if (e.touches.length === 1) {
                    isPanning = true;
                    startX = e.touches[0].clientX - panX;
                    startY = e.touches[0].clientY - panY;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isPanning || e.touches.length !== 1) return;
                panX = e.touches[0].clientX - startX;
                panY = e.touches[0].clientY - startY;
                updatePan();
            }, { passive: true });

            document.addEventListener('touchend', () => { isPanning = false; });

            gameWorld.style.cursor = 'grab';
        }

        function updatePan() {
            const gameWorld = document.getElementById('game-world');
            gameWorld.style.transform = `translate(${panX}px, ${panY}px)`;
        }

        async function init() {
            const user = tg?.initDataUnsafe?.user;
            // Update level circle
            const levelCircle = document.getElementById('level-circle');
            if (levelCircle) levelCircle.textContent = '5';

            configs = await api('/api/configs');
            const plotCfg = await api('/api/configs/plots/plot');

            // Load user inventory from database
            await loadInventory();

            // Load map objects (factories) FIRST so they appear behind plots
            await loadMapObjects();

            // Create plots
            const grid = document.getElementById('farm-grid');
            const emptyPlotImg = plotCfg?.stages?.empty?.image;
            const blockedPlotImg = plotCfg?.stages?.blocked?.image;
            const basePlots = plotCfg?.base_plots || 6;
            const totalPlots = plotCfg?.total_plots || 32;
            const cols = 4;
            const gapX = 52, gapY = 26; // half tile size for isometric grid

            for (let i = 0; i < totalPlots; i++) {
                const isBlocked = i >= basePlots;
                plots[i] = { state: isBlocked ? 'blocked' : 'empty', crop: null, stage: 0 };
                const row = Math.floor(i / cols);
                const col = i % cols;

                // Isometric diamond grid positioning (row 0 at top-left)
                const x = (row - col) * gapX + 200;
                const y = (col + row) * gapY + 50;

                const plot = document.createElement('div');
                plot.className = isBlocked ? 'plot blocked' : 'plot empty';
                plot.dataset.id = i;
                plot.style.left = `${x}px`;
                plot.style.top = `${y}px`;

                const plotImg = isBlocked ? blockedPlotImg : emptyPlotImg;
                if (plotImg) {
                    plot.style.backgroundImage = `url('../deno/${plotImg}')`;
                }
                if (isBlocked) {
                    plot.style.opacity = '0.5';
                }
                plot.onclick = () => onPlotClick(i);
                grid.appendChild(plot);
            }

            // Load planted crops from database and restore visuals
            await restorePlantedCrops();

            // Setup toolbar
            document.querySelectorAll('.tool').forEach(tool => {
                tool.onclick = () => {
                    document.querySelector('.tool.active')?.classList.remove('active');
                    tool.classList.add('active');
                    currentTool = tool.dataset.tool;
                };
            });

            // Enable map panning
            initMapPanning();
        }

        async function loadMapObjects() {
            const factoriesLayer = document.getElementById('factories-layer');
            const factories = await api('/api/configs/factories');

            for (const [code, cfg] of Object.entries(factories || {})) {
                if (!cfg.position) continue; // Skip factories without position

                const isDecoration = cfg.decoration === true;
                const obj = document.createElement('div');
                obj.className = isDecoration ? 'map-object decoration' : 'map-object';
                // Position from center using translate for proper background attachment
                obj.style.left = '50%';
                obj.style.top = '50%';
                obj.style.transform = `translate(${cfg.position.x}%, ${cfg.position.y}%)`;
                if (isDecoration) {
                    obj.style.pointerEvents = 'none';
                    obj.style.cursor = 'default';
                }

                // Get image from stages (default to idle)
                const stageImage = cfg.stages?.idle?.image || cfg.stages?.ready?.image;
                const imagePath = stageImage ? `../deno/${stageImage}` : null;

                const iconWidth = cfg.size?.width || 80;
                const iconHtml = imagePath
                    ? `<img src="${imagePath}" alt="${text(cfg.name)}" style="width:${iconWidth}px;height:auto;">`
                    : `<span style="font-size:70px">${cfg.icon || 'üè≠'}</span>`;

                // Decorations don't have labels
                obj.innerHTML = isDecoration
                    ? `<div class="object-icon">${iconHtml}</div>`
                    : `<div class="object-icon">${iconHtml}</div><div class="object-label">${text(cfg.name)}</div>`;

                if (!isDecoration) {
                    obj.onclick = () => showFactoryModal(code, cfg);
                }
                factoriesLayer.appendChild(obj);
            }
        }

        async function showFactoryModal(code, cfg) {
            document.getElementById('modal-title').textContent = text(cfg.name);
            const crops = await api('/api/configs/crops');

            let html = `<p style="margin-bottom:15px;color:#5D4037">${text(cfg.description)}</p>`;
            html += '<div class="shop-grid">';

            for (const recipe of cfg.recipes || []) {
                // Check ingredients
                let ingredientsHtml = '';
                let canProduce = true;

                for (const input of recipe.inputs || []) {
                    const itemKey = `item_${input.item}`;
                    const have = inventory[itemKey] || 0;
                    const need = input.count;
                    const enough = have >= need;
                    if (!enough) canProduce = false;

                    const cropCfg = crops?.[input.item];
                    const itemName = text(cropCfg?.name) || input.item;
                    const color = enough ? '#4CAF50' : '#F44336';
                    ingredientsHtml += `<div style="font-size:11px;color:${color}">${itemName}: ${have}/${need}</div>`;
                }

                const btnStyle = canProduce
                    ? 'background:#4CAF50;color:white;cursor:pointer'
                    : 'background:#ccc;color:#666;cursor:not-allowed';
                const onclick = canProduce
                    ? `startProduction('${code}','${recipe.code}')`
                    : '';

                // Get product icon
                const product = recipe.products?.[0];
                const productIcon = product?.code?.includes('juice') ? 'üßÉ' : product?.code?.includes('chips') ? 'üçü' : 'üì¶';

                html += `<div class="shop-item" ${onclick ? `onclick="${onclick}"` : ''}>
                    <div class="shop-item-icon">${productIcon}</div>
                    <div class="shop-item-name">${text(recipe.name)}</div>
                    <div style="font-size:10px;color:#888">‚è± ${Math.floor(recipe.time / 60)}–º–∏–Ω</div>
                    <div style="margin-top:5px;border-top:1px solid #eee;padding-top:5px">
                        ${ingredientsHtml}
                    </div>
                    <div style="margin-top:5px;padding:3px 6px;border-radius:4px;${btnStyle}">
                        ${canProduce ? '‚ñ∂ –ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏' : '‚úó –ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤'}
                    </div>
                </div>`;
            }
            html += '</div>';
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal').classList.add('active');
        }

        // Store current factory configs for startProduction
        let factoryConfigs = {};

        async function startProduction(factoryCode, recipeCode) {
            // Get factory config
            const cfg = await api(`/api/configs/factories/${factoryCode}`);
            const recipe = cfg?.recipes?.find(r => r.code === recipeCode);
            if (!recipe) {
                alert('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            // Check and deduct ingredients
            for (const input of recipe.inputs || []) {
                const itemKey = `item_${input.item}`;
                const have = inventory[itemKey] || 0;
                if (have < input.count) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${input.item}!`);
                    return;
                }
            }

            // Deduct ingredients
            for (const input of recipe.inputs || []) {
                await modifyStat(`item_${input.item}`, -input.count);
            }

            closeModal();

            // Add products after production time (simplified - instant for demo)
            for (const product of recipe.products || []) {
                await modifyStat(`item_${product.code}`, product.count);
            }

            // Add experience
            await modifyStat('exp', recipe.exp || 10);

            alert(`${text(recipe.name)} –≥–æ—Ç–æ–≤!`);
        }

        window.startProduction = startProduction;

        async function onPlotClick(id) {
            const plot = plots[id];
            console.log('[PLOT] Click on plot', id, 'state:', plot?.state, 'currentTool:', currentTool);

            // Ready crop - always harvest on click
            if (plot.state === 'ready') {
                await harvestCrop(id);
                return;
            }

            // Empty plot with plant tool - show crop selector
            if (plot.state === 'empty') {
                await showCropSelector(id);
            }
        }

        async function showCropSelector(plotId) {
            const crops = await api('/api/configs/crops');
            const plotCfg = await api('/api/configs/plots/plot');
            document.getElementById('modal-title').textContent = text(plotCfg?.ui?.labels?.select_crop) || '–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ–Ω–∞';
            document.getElementById('modal-footer').style.display = 'none';

            // Filter only crops that user has seeds for
            const availableCrops = Object.entries(crops || {}).filter(([code]) => {
                const seedCount = inventory[`seed_${code}`] || 0;
                return seedCount > 0;
            });

            if (availableCrops.length === 0) {
                document.getElementById('modal-body').innerHTML = `
                    <p style="color:#888;text-align:center;padding:30px">
                        –£ –≤–∞—Å –Ω–µ—Ç —Å–µ–º—è–Ω!<br><br>
                        <button onclick="closeModal(); showModal('shop')" style="padding:10px 20px;background:#4CAF50;color:white;border:none;border-radius:6px;cursor:pointer">
                            –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω
                        </button>
                    </p>
                `;
            } else {
                document.getElementById('modal-body').innerHTML = `
                    <div class="shop-grid">
                        ${availableCrops.map(([code, c]) => {
                    const seedImg = c.stages?.seed?.image;
                    const iconHtml = seedImg
                        ? `<img src="../deno/${seedImg}">`
                        : 'üå±';
                    const seedCount = inventory[`seed_${code}`] || 0;
                    return `
                                <div class="shop-item" onclick="plantCrop(${plotId}, '${code}')">
                                    <span class="shop-item-qty">${seedCount}</span>
                                    <div class="shop-item-icon">${iconHtml}</div>
                                    <div class="shop-item-name">${text(c.name)}</div>
                                    <div class="shop-item-price">${seedCount} —Å–µ–º—è–Ω</div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            }
            document.getElementById('modal').classList.add('active');
        }

        async function plantCrop(plotId, cropCode) {
            // Check if user has seeds
            const seedKey = `seed_${cropCode}`;
            if ((inventory[seedKey] || 0) < 1) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–µ–º—è–Ω! –ö—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.');
                return;
            }

            closeModal();

            // Use seed from inventory
            await modifyStat(seedKey, -1);

            const cropCfg = await api(`/api/configs/crops/${cropCode}`);
            const plotEl = document.querySelector(`.plot[data-id="${plotId}"]`);
            const plantedAt = Date.now();
            plots[plotId] = { state: 'planted', crop: cropCode, stage: 'seed', config: cropCfg, plantedAt };
            plotEl.classList.remove('empty');
            plotEl.classList.add('planted');

            // Save to database
            await savePlantedCrop(plotId, cropCode, 'seed', plantedAt);

            const stageNames = { seed: '1/4', sprout: '2/4', growing: '3/4', ripe: '‚úì' };

            function updatePlotImage(stage) {
                const img = cropCfg?.stages?.[stage]?.image;
                const html = img
                    ? `<img src="../deno/${img}" class="crop-img">`
                    : `<div class="crop-img" style="font-size:30px;text-align:center">${stage === 'ripe' ? 'üçé' : 'üå±'}</div>`;
                plotEl.innerHTML = `${html}<span class="stage-indicator">${stageNames[stage]}</span>`;
            }

            updatePlotImage('seed');
            setTimeout(() => updatePlotImage('sprout'), 3000);
            setTimeout(() => updatePlotImage('growing'), 6000);
            setTimeout(() => { updatePlotImage('ripe'); plots[plotId].state = 'ready'; }, 9000);
        }

        async function harvestCrop(plotId) {
            const plot = plots[plotId];
            const cropCode = plot?.crop;
            const cropCfg = plot?.config;

            const plotEl = document.querySelector(`.plot[data-id="${plotId}"]`);
            const plotCfg = await api('/api/configs/plots/plot');
            const emptyPlotImg = plotCfg?.stages?.empty?.image;

            // Calculate yield (random between min and max)
            const yieldRange = cropCfg?.yield || [1, 3];
            const harvestQty = Math.floor(Math.random() * (yieldRange[1] - yieldRange[0] + 1)) + yieldRange[0];

            // Add to warehouse inventory
            const itemKey = `item_${cropCode}`;
            await modifyStat(itemKey, harvestQty);

            // Add experience
            const exp = cropCfg?.exp || 5;
            await modifyStat('exp', exp);

            // Delete from database
            await deletePlantedCrop(plotId);

            // Show harvest animation
            plotEl.innerHTML = `<div style="color:white;font-size:14px;text-shadow:1px 1px 2px black">+${harvestQty} üçé</div>`;

            setTimeout(() => {
                plotEl.innerHTML = '';
                plotEl.classList.remove('planted');
                plotEl.classList.add('empty');
                if (emptyPlotImg) {
                    plotEl.style.backgroundImage = `url('../deno/${emptyPlotImg}')`;
                }
                plots[plotId] = { state: 'empty', crop: null, stage: 0 };
            }, 1000);
        }

        async function showModal(type) {
            const cfg = await api(`/api/configs/ui/${type}`);
            document.getElementById('modal-title').textContent = text(cfg?.name) || type;
            document.getElementById('modal-footer').style.display = 'none';

            if (type === 'shop') {
                // Shop: buy seeds with quantity selector
                const crops = await api('/api/configs/crops');
                let html = '<div class="shop-grid">';
                for (const [code, c] of Object.entries(crops || {})) {
                    const seedImg = c.stages?.seed?.image;
                    const iconHtml = seedImg ? `<img src="../deno/${seedImg}">` : 'üå±';
                    const owned = inventory[`seed_${code}`] || 0;
                    const isFree = c.buy_silver === 0;
                    html += `<div class="shop-item">
                        ${owned > 0 ? `<span class="shop-item-qty">${owned}</span>` : ''}
                        <div class="shop-item-icon">${iconHtml}</div>
                        <div class="shop-item-name">${text(c.name)}</div>
                        <div class="shop-item-price">${isFree ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : c.buy_silver + ' ü™ô'}</div>
                        <div class="qty-selector">
                            <button onclick="changeQty('${code}', -1)">‚àí</button>
                            <input type="number" id="qty_${code}" value="1" min="1" max="99" readonly>
                            <button onclick="changeQty('${code}', 1)">+</button>
                        </div>
                        <button onclick="buySeeds('${code}', ${c.buy_silver})" style="margin-top:6px;width:100%;padding:6px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer">
                            –ö—É–ø–∏—Ç—å
                        </button>
                    </div>`;
                }
                html += '</div>';
                document.getElementById('modal-body').innerHTML = html;

            } else if (type === 'warehouse') {
                // Warehouse: show items with total and sell all
                const crops = await api('/api/configs/crops');
                const items = Object.entries(inventory).filter(([k, v]) => k.startsWith('item_') && v > 0);

                if (items.length === 0) {
                    document.getElementById('modal-body').innerHTML = '<p style="color:#888;text-align:center;padding:40px">–°–∫–ª–∞–¥ –ø—É—Å—Ç</p>';
                } else {
                    let html = '<div class="shop-grid">';
                    let totalValue = 0;

                    for (const [key, qty] of items) {
                        const code = key.replace('item_', '');
                        const cropCfg = crops?.[code];
                        const ripeImg = cropCfg?.stages?.ripe?.image;
                        const iconHtml = ripeImg ? `<img src="../deno/${ripeImg}">` : 'üì¶';
                        const sellPrice = cropCfg?.sell_silver || cropCfg?.products?.[0]?.sell_silver || 10;
                        totalValue += sellPrice * qty;

                        html += `<div class="shop-item">
                            <span class="shop-item-qty">${qty}</span>
                            <div class="shop-item-icon">${iconHtml}</div>
                            <div class="shop-item-name">${text(cropCfg?.name) || code}</div>
                            <div class="shop-item-price">${sellPrice} ü™ô / —à—Ç</div>
                            <div class="qty-selector">
                                <button onclick="changeSellQty('${code}', -1, ${qty})">‚àí</button>
                                <input type="number" id="sell_${code}" value="${qty}" min="1" max="${qty}" readonly>
                                <button onclick="changeSellQty('${code}', 1, ${qty})">+</button>
                            </div>
                            <button onclick="sellItems('${code}', ${sellPrice})" style="margin-top:6px;width:100%;padding:6px;background:#FF9800;color:white;border:none;border-radius:4px;cursor:pointer">
                                –ü—Ä–æ–¥–∞—Ç—å
                            </button>
                        </div>`;
                    }
                    html += '</div>';
                    document.getElementById('modal-body').innerHTML = html;

                    // Show footer with total and sell all button
                    document.getElementById('modal-footer').style.display = 'flex';
                    document.getElementById('modal-total').textContent = totalValue.toLocaleString();
                    document.getElementById('modal-action-btn').textContent = '–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë';
                    document.getElementById('modal-action-btn').onclick = () => confirmSellAll(totalValue);
                }

            } else if (type === 'friends') {
                document.getElementById('modal-body').innerHTML = '<p style="color:#888;text-align:center;padding:40px">–î—Ä—É–∑—å—è —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è!</p>';

            } else if (type === 'settings') {
                document.getElementById('modal-body').innerHTML = `
                    <div style="padding:20px">
                        <p><b>–Ø–∑—ã–∫:</b> –†—É—Å—Å–∫–∏–π</p>
                        <p><b>–ó–≤—É–∫–∏:</b> –í–∫–ª</p>
                    </div>
                `;
            } else {
                document.getElementById('modal-body').innerHTML = `<p style="padding:20px">${text(cfg?.description) || ''}</p>`;
            }
            document.getElementById('modal').classList.add('active');
        }

        // Quantity helpers
        function changeQty(code, delta) {
            const input = document.getElementById(`qty_${code}`);
            const newVal = Math.max(1, Math.min(99, parseInt(input.value) + delta));
            input.value = newVal;
        }

        function changeSellQty(code, delta, max) {
            const input = document.getElementById(`sell_${code}`);
            const newVal = Math.max(1, Math.min(max, parseInt(input.value) + delta));
            input.value = newVal;
        }

        // Buy seeds with quantity
        async function buySeeds(cropCode, pricePerUnit) {
            const qty = parseInt(document.getElementById(`qty_${cropCode}`)?.value || 1);
            const totalPrice = pricePerUnit * qty;

            if (totalPrice > 0 && (inventory.silver || 0) < totalPrice) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
                return;
            }

            if (totalPrice > 0) {
                await modifyStat('silver', -totalPrice);
            }
            await modifyStat(`seed_${cropCode}`, qty);
            updateResourcesUI();
            showModal('shop'); // Refresh
        }

        // Sell items with quantity
        async function sellItems(itemCode, pricePerUnit) {
            const qty = parseInt(document.getElementById(`sell_${itemCode}`)?.value || 1);
            const key = `item_${itemCode}`;

            if ((inventory[key] || 0) < qty) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞!');
                return;
            }

            await modifyStat(key, -qty);
            await modifyStat('silver', pricePerUnit * qty);
            updateResourcesUI();
            showModal('warehouse'); // Refresh
        }

        // Confirm sell all
        function confirmSellAll(totalValue) {
            document.getElementById('submodal-title').textContent = '–ü—Ä–æ–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã';
            document.getElementById('submodal-text').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞ –∑–∞ ${totalValue.toLocaleString()} ü™ô?`;
            document.getElementById('submodal-ok').onclick = async () => {
                await sellAllItems();
                closeSubmodal();
            };
            document.getElementById('submodal').classList.add('active');
        }

        async function sellAllItems() {
            const crops = await api('/api/configs/crops');
            const items = Object.entries(inventory).filter(([k, v]) => k.startsWith('item_') && v > 0);

            for (const [key, qty] of items) {
                const code = key.replace('item_', '');
                const cropCfg = crops?.[code];
                const sellPrice = cropCfg?.sell_silver || cropCfg?.products?.[0]?.sell_silver || 10;

                await modifyStat(key, -qty);
                await modifyStat('silver', sellPrice * qty);
            }

            updateResourcesUI();
            showModal('warehouse');
        }

        function closeSubmodal() {
            document.getElementById('submodal').classList.remove('active');
        }

        window.changeQty = changeQty;
        window.changeSellQty = changeSellQty;
        window.buySeeds = buySeeds;
        window.sellItems = sellItems;
        window.confirmSellAll = confirmSellAll;
        window.closeSubmodal = closeSubmodal;

        // Buy seed
        async function buySeed(cropCode, price) {
            if ((inventory.silver || 0) < price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
                return;
            }
            await modifyStat('silver', -price);
            await modifyStat(`seed_${cropCode}`, 1);
            updateResourcesUI();
            showModal('shop'); // Refresh
        }

        // Sell item from warehouse
        async function sellItem(itemCode, qty, pricePerUnit) {
            const key = `item_${itemCode}`;
            if ((inventory[key] || 0) < qty) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞!');
                return;
            }
            await modifyStat(key, -qty);
            await modifyStat('silver', pricePerUnit * qty);
            updateResourcesUI();
            showModal('warehouse'); // Refresh
        }

        window.buySeed = buySeed;
        window.sellItem = sellItem;

        function closeModal() { document.getElementById('modal').classList.remove('active'); }

        init();
    </script>
</body>

</html>